---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <h1 class="text-2xl">Simple Penguin</h1>

  <select name="species" id="species">
    <option value="">Toutes les espèces</option>
    <option value="Adelie">Adelie</option>
    <option value="Chinstrap">Chinstrap</option>
    <option value="Gentoo">Gentoo</option>
  </select>

  <select name="island" id="island">
    <option value="">Toutes les îles</option>
    <option value="Biscoe">Biscoe</option> 
    <option value="Dream">Dream</option>
    <option value="Torgersen">Torgersen</option>
  </select>

  <select name="sex" id="sex">
    <option value="">Tous les genres</option>
    <option value="MALE">Mâle</option>
    <option value="FEMALE">Femelle</option>
  </select>

  <div id="myplot"></div>
  

<script>
  import * as Plot from "@observablehq/plot";
  import penguins from "../assets/penguins.json";

  const selectSpecies = document.querySelector("#species") as HTMLSelectElement;
  const selectIsland = document.querySelector("#island") as HTMLSelectElement;
  const selectSex = document.querySelector("#sex") as HTMLSelectElement;

  interface Filters {
    species: string;
    island: string;
    sex: string;
  }

  function getFilters(): Filters {
    return {
      species: selectSpecies?.value || "",
      island: selectIsland?.value || "",
      sex: selectSex?.value || ""
    };
  }

  function filterPenguins(penguins: any[], filters: Filters): any[] {
    return penguins.filter((penguin: any) => {
      const matchSpecies = !filters.species || penguin.species === filters.species;
      const matchIsland = !filters.island || penguin.island === filters.island;
      const matchSex = !filters.sex || penguin.sex === filters.sex;
      
      return matchSpecies && matchIsland && matchSex;
    });
  }

  function renderPlot() {
    const filters = getFilters();
    const div = document.querySelector("#myplot");
    
    if (div) {
      div.innerHTML = "";
    }
    
    const filteredData = filterPenguins(penguins, filters);
    
    const plot = Plot.plot({
      marks: [
        Plot.dot(filteredData, {
          x: "culmen_length_mm",
          y: "culmen_depth_mm",
          stroke: "species",
        }),
      ],
    });
    
    div?.append(plot);
  }

  selectSpecies?.addEventListener("change", renderPlot);
  selectIsland?.addEventListener("change", renderPlot);
  selectSex?.addEventListener("change", renderPlot);
  
  renderPlot();
</script>
</Layout>